<% content_for :title, t(".title") %>

<div class="filmes-page">
  <div class="busca mb-4">
    <%= search_form_for @q, url: filmes_path, method: :get, local: true, class: "row g-2" do |f| %>
      <div class="col-md-4">
        <%= f.text_field :titulo_cont, placeholder: t(".search_by_title"), class: "form-control" %>
      </div>
      <div class="col-md-4">
        <%= f.text_field :diretor_cont, placeholder: t(".search_by_director"), class: "form-control" %>
      </div>
      <div class="col-md-2">
        <%= f.number_field :ano_eq, placeholder: t(".search_by_year"), class: "form-control" %>
      </div>
      <div class="col-md-2">
        <%= f.submit t("search"), class: "botao botao--primario botao--pequeno botao--completo" %>
      </div>
    <% end %>
  </div>

  <div class="row">
    <div class="col-md-3 filtros">
      <% if usuario_signed_in? %>
        <div class="mb-3 d-flex gap-2">
          <%= link_to t(".new_movie_button"), new_filme_path, class: "botao botao--sucesso botao--pequeno botao--completo" %>
        </div>
      <% end %>
      <%= search_form_for @q, url: filmes_path, method: :get, local: true do |f| %>
        <div class="accordion" id="filtrosAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingCategorias">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategorias" aria-expanded="false" aria-controls="collapseCategorias">
                <%= t("categories") %>
              </button>
            </h2>
            <div id="collapseCategorias" class="accordion-collapse collapse" aria-labelledby="headingCategorias" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <% if @categorias.any? %>
                  <% @categorias.each do |c| %>
                    <div class="form-check d-flex justify-content-between">
                      <%= check_box_tag "q[por_categorias][]", c.id, params.dig(:q, :por_categorias)&.include?(c.id.to_s), class: "form-check-input", id: "cat_#{c.id}" %>
                      <%= label_tag "cat_#{c.id}", c.nome, class: "form-check-label flex-grow-1" %>
                      <span class="text-muted ms-2"><%= c.filmes.count %></span>
                    </div>
                  <% end %>
                <% else %>
                  <p class="text-muted"><%= t(".no_categories_available") %></p>
                <% end %>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingDiretores">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDiretores" aria-expanded="false" aria-controls="collapseDiretores">
                <%= t("directors") %>
              </button>
            </h2>
            <div id="collapseDiretores" class="accordion-collapse collapse" aria-labelledby="headingDiretores" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <% if @diretores.any? %>
                  <% @diretores.each do |d| %>
                    <div class="form-check d-flex justify-content-between">
                      <%= check_box_tag "q[diretor_in][]", d, params.dig(:q, :diretor_in)&.include?(d), class: "form-check-input", id: "dir_#{d.parameterize}" %>
                      <%= label_tag "dir_#{d.parameterize}", d, class: "form-check-label flex-grow-1" %>
                      <span class="text-muted ms-2"><%= Filme.where(diretor: d).count %></span>
                    </div>
                  <% end %>
                <% else %>
                  <p class="text-muted"><%= t(".no_directors_available") %></p>
                <% end %>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <h2 class="accordion-header" id="headingAnos">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnos" aria-expanded="false" aria-controls="collapseAnos">
                <%= t("years") %>
              </button>
            </h2>
            <div id="collapseAnos" class="accordion-collapse collapse" aria-labelledby="headingAnos" data-bs-parent="#filtrosAccordion">
              <div class="accordion-body">
                <% if @anos.any? %>
                  <% @anos.each do |a| %>
                    <div class="form-check d-flex justify-content-between">
                      <%= check_box_tag "q[ano_in][]", a, params.dig(:q, :ano_in)&.include?(a.to_s), class: "form-check-input", id: "ano_#{a}" %>
                      <%= label_tag "ano_#{a}", a, class: "form-check-label flex-grow-1" %>
                      <span class="text-muted ms-2"><%= Filme.where(ano: a).count %></span>
                    </div>
                  <% end %>
                <% else %>
                  <p class="text-muted"><%= t(".no_years_available") %></p>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <%= link_to t(".clear_filters"), filmes_path, class: "text-decoration-none text-muted" %>
          <%= submit_tag t("filter"), class: "botao botao--primario botao--pequeno botao--completo" %>
        </div>
    <% end %>
    </div>

    <div class="col-md-9 cards-filmes">
      <div class="row row-cols-1 row-cols-md-3 g-4">
        <% if @filmes.any? %>
          <% @filmes.each do |filme| %>
            <%= render filme %>
          <% end %>
        <% else %>
          <div class="col">
            <p class="text-muted"><%= t(".no_movies_found") %></p>
          </div>
        <% end %>
      </div>

      <div class="d-flex justify-content-center mt-4">
        <%= will_paginate @filmes,
                          previous_label: '« Anterior',
                          next_label: 'Próximo »',
                          class: 'paginacao' %>
      </div>
    </div>
  </div>
</div>